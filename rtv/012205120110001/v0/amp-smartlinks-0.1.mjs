;
(self.AMP=self.AMP||[]).push({m:1,v:"2205120110001",n:"amp-smartlinks",ev:"0.1",l:!0,f:function(t,n){(()=>{var n="load-start",{isArray:i}=Array,{hasOwnProperty:s,toString:e}=Object.prototype;function r(t){return(t.ownerDocument||t).defaultView}function o(t,n,i){return function(t,n){for(const i in n)t.setAttribute(i,n[i]);return t}(t.createElement(n),i)}self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var h,u=self.__AMP_LOG;function c(t){return function(t,n){throw new Error("failed to call initLogConstructor")}()}function l(t,n,i,s,e,r,o,h,u,c,l){return t}function a(){return h||(h=Promise.resolve(void 0))}function _(t,n){return A(t=function(t){return t.__AMP_TOP||(t.__AMP_TOP=t)}(t),n)}function f(t,n){return A(m(P(t)),n)}function p(t,n){return function(t,n){const i=k(t,n);if(i)return i;const s=v(t);return s[n]=function(){const t=new class{constructor(){this.promise=new Promise(((t,n)=>{this.resolve=t,this.reject=n}))}},{promise:n,reject:i,resolve:s}=t;return n.catch((()=>{})),{obj:null,promise:n,resolve:s,reject:i,context:null,ctor:null}}(),s[n].promise}(m(t),n)}function d(t,n){return k(m(t),n)}function P(t){return t.nodeType?(n=r(t),_(n,"ampdoc")).getAmpDoc(t):t;var n}function m(t){const n=P(t);return n.isSingleDoc()?n.win:n}function A(t,n){l(function(t,n){const i=t.__AMP_SERVICES&&t.__AMP_SERVICES[n];return!(!i||!i.ctor)}(t,n));const i=v(t)[n];return i.obj||(l(i.ctor),l(i.context),i.obj=new i.ctor(i.context),l(i.obj),i.context=null,i.resolve&&i.resolve(i.obj)),i.obj}function k(t,n){const i=v(t)[n];return i?i.promise?i.promise:(A(t,n),i.promise=Promise.resolve(i.obj)):null}function v(t){let n=t.__AMP_SERVICES;return n||(n=t.__AMP_SERVICES={}),n}var I=t=>function(t,n,i,s){const e=d(t,n);if(e)return e;const r=P(t);return r.whenExtensionsKnown().then((()=>{const t=r.getExtensionVersion(i);return t?_(r.win,"extensions").waitForExtension(i,t):null})).then((i=>i?p(t,n):null))}(t,"amp-analytics-instrumentation","amp-analytics");function T(t){return t.data}var E="https://api.narrativ.com/api",g={PAGE_IMPRESSION_ENDPOINT:`${E}/v1/events/impressions/page_impression/`,NRTV_CONFIG_ENDPOINT:`${E}/v0/publishers/.nrtv_slug./amp_config/`,LINKMATE_ENDPOINT:`${E}/v1/publishers/.pub_id./linkmate/smart_links/`},R=class{constructor(t,n){this.syncResponse=t,this.asyncResponse=n}};function w(t){return t.getAttribute("nrtv-account-name").toLowerCase()}function b(t){return!!t.hasAttribute("linkmate")}function M(t){return!!t.hasAttribute("exclusive-links")}function V(t){const n=t.getAttribute("link-attribute");return n?n.toLowerCase():"href"}function y(t){const n=t.getAttribute("link-selector");return n?n.toLowerCase():"a"}var L,N=(new Set(["c","v","a","ad"]),0),x="data-link-rewriter-original-url",U=["Webkit","webkit","Moz","moz","ms","O","o"];function C(t,n,i,s,e){const r=function(t,n,i){if(n.startsWith("--"))return n;L||(L=Object.create(null));let s=L[n];if(!s||i){if(s=n,void 0===t[n]){const i=function(t){return t.charAt(0).toUpperCase()+t.slice(1)}(n),e=function(t,n){for(let i=0;i<U.length;i++){const s=U[i]+n;if(void 0!==t[s])return s}return""}(t,i);void 0!==t[e]&&(s=e)}i||(L[n]=s)}return s}(t.style,n,e);if(!r)return;const o=s?i+s:i;t.style.setProperty(function(t){const n=t.replace(/[A-Z]/g,(t=>"-"+t.toLowerCase()));return U.some((t=>n.startsWith(t+"-")))?`-${n}`:n}(r),o)}var O=!1,S=/nochunking=1/.test(self.location.hash),j=a();var D="not_run",$=class{constructor(t){this.state=D,this.Qi=t}Xi(t){if("run"!=this.state){this.state="run";try{this.Qi(t)}catch(t){throw this.Zi(t),t}}}ts(){return this.Qi.displayName||this.Qi.name}Zi(t){}ss(){return!1}es(){return!1}},q=class extends ${constructor(t,n,i){super(t),this.ns=i}Zi(t){var n;l((n=self.document).defaultView),O||(O=!0,function(t){!function(t,n){for(const i in n)C(t,i,n[i])}(t.body,{opacity:1,visibility:"visible","animation":"none"})}(n))}ss(){return this.rs()}es(){return this.ns.hs}rs(){return this.ns.ampdoc.isVisible()}},F=class{constructor(t){var n;this.ampdoc=t,this.i=t.win,this.os=new class{constructor(){this.Ki=[]}peek(){const t=this.length;return t?this.Ki[t-1].item:null}enqueue(t,n){if(isNaN(n))throw new Error("Priority must not be NaN.");const i=this.Yi(n);this.Ki.splice(i,0,{item:t,priority:n})}Yi(t){let n=-1,i=0,s=this.length;for(;i<=s&&(n=Math.floor((i+s)/2),n!==this.length);)if(this.Ki[n].priority<t)i=n+1;else{if(!(n>0&&this.Ki[n-1].priority>=t))break;s=n-1}return n}forEach(t){let n=this.length;for(;n--;)t(this.Ki[n].item)}dequeue(){const t=this.Ki.pop();return t?t.item:null}get length(){return this.Ki.length}},this.us=this.ls.bind(this),this.cs=0,this.ds=!(!this.i.navigator.scheduling||!this.i.navigator.scheduling.isInputPending),this.fs=!1,this.Ji=this.i.document.documentElement.hasAttribute("i-amphtml-no-boilerplate"),this.i.addEventListener("message",(t=>{"amp-macro-task"==T(t)&&this.ls(null)})),this.hs=!1,(n=t,p(n,"viewer")).then((()=>{this.hs=!0})),t.onVisibilityChanged((()=>{t.isVisible()&&this.ps()}))}run(t,n){const i=new $(t);this._s(i,n)}runForStartup(t){const n=new q(t,this.i,this);this._s(n,Number.POSITIVE_INFINITY)}_s(t,n){this.os.enqueue(t,n),this.ps()}As(t){let n=this.os.peek();for(;n&&n.state!==D;)this.os.dequeue(),n=this.os.peek();return n&&t&&this.os.dequeue(),n}ls(t){const n=this.As(!0);if(!n)return this.fs=!1,this.cs=0,!1;let i;try{i=Date.now(),n.Xi(t)}finally{j.then().then().then().then().then().then().then().then().then((()=>{this.fs=!1,this.cs+=Date.now()-i,this.ps()}))}return!0}gs(t){if(this.Ji&&(this.ds?this.i.navigator.scheduling.isInputPending():this.cs>5))return this.cs=0,void this.Ps();j.then((()=>{this.us(t)}))}ps(){if(this.fs)return;const t=this.As();return t?t.ss()?(this.fs=!0,void this.gs(null)):void(t.es()&&this.i.requestIdleCallback?function(t,n,i,s){const e=Date.now();t.requestIdleCallback((function n(i){if(i.timeRemaining()<15){const r=2e3-(Date.now()-e);r<=0||i.didTimeout?s(i):t.requestIdleCallback(n,{timeout:r})}else s(i)}),{timeout:2e3})}(this.i,0,0,this.us):this.Ps()):void 0}Ps(){this.i.postMessage("amp-macro-task","*")}},G=class extends t.BaseElement{constructor(t){super(t),this.NR=null,this.OI=null,this.Ak=null,this.qU=null,this.GU=null,this.KU=null,this.RI=null}buildCallback(){this.OI=this.getAmpDoc(),this.NR=_(this.OI.win,"xhr");const t=f(this.OI,"viewer");var n;return this.GU={nrtvSlug:w(n=this.element),linkmateEnabled:b(n),exclusiveLinks:M(n),linkAttribute:V(n),linkSelector:y(n)},this.Ak=new class{constructor(t){var n;this.Rc=t.getRootNode(),this.Rk=this.bk(t),this.Ek=[],this.Mk(this.Rc),(n=t,f(n,"navigation")).registerAnchorMutator(this.maybeRewriteLink.bind(this),N)}registerLinkRewriter(t,n,i){const s=new class{constructor(t,n,i,s){this.events=new class{constructor(){this.St=null}add(t){return this.St||(this.St=[]),this.St.push(t),()=>{this.remove(t)}}remove(t){this.St&&function(t,n){const i=t.indexOf(n);-1!=i&&t.splice(i,1)}(this.St,t)}removeAll(){this.St&&(this.St.length=0)}fire(t){if(this.St)for(const n of this.St.slice())n(t)}getHandlerCount(){var t,n;return null!==(t=null===(n=this.St)||void 0===n?void 0:n.length)&&void 0!==t?t:0}},this.id=n,this.Rc=t,this.Vk=i,this.Uk=s.linkSelector||"a",this.yk=300,this.Ok=new class{constructor(){this.Lk=[],this.$k=[]}updateLinkList(t){this.$k=t.map(this.getReplacementUrlForAnchor.bind(this)),this.Lk=t}updateReplacementUrls(t){t.forEach((t=>{const{anchor:n,replacementUrl:i}=t,s=this.Lk.indexOf(n);-1!==s&&(this.$k[s]=i)}))}getReplacementUrlForAnchor(t){const n=this.Lk.indexOf(t);return-1!==n?this.$k[n]:null}isInCache(t){return-1!==this.Lk.indexOf(t)}getAnchorReplacementList(){return this.Lk.map((t=>({anchor:t,replacementUrl:this.getReplacementUrlForAnchor(t)})))}}}getReplacementUrl(t){return this.isWatchingLink(t)?this.Ok.getReplacementUrlForAnchor(t):null}getAnchorReplacementList(){return this.Ok.getAnchorReplacementList()}isWatchingLink(t){return this.Ok.isInCache(t)}rewriteAnchorUrl(t){const n=this.getReplacementUrl(t);return!(!n||n===t.href||(t.setAttribute(x,t.href),t.href=n,setTimeout((()=>{t.href=t.getAttribute(x),t.removeAttribute(x)}),this.yk),0))}onDomUpdated(){return new Promise((t=>{!function(t,n,i){if(S)return void j.then(n);const s=function(t){return function(t,n,i,s){const e=P(t);!function(t,n,i,s,e,r){const o=v(t);let h=o[i];h||(h=o[i]={obj:null,promise:null,resolve:null,reject:null,context:null,ctor:null,sharedInstance:!1}),h.ctor||(h.ctor=s,h.context=n,h.sharedInstance=!1,h.resolve&&A(t,i))}(m(e),e,n,i)}(t,"chunk",F),f(t,"chunk")}(t);s.run(n,i)}(this.Rc.nodeType==Node.DOCUMENT_NODE?this.Rc.documentElement:this.Rc,(()=>this.jk().then((()=>{this.events.fire({type:"PAGE_SCANNED"}),t()}))),10)}))}jk(){const t=this.xk(),n=this.Sk(t);if(this.Ok.updateLinkList(t),!n.length)return a();this.Ok.updateReplacementUrls(n.map((t=>({anchor:t,replacementUrl:null}))));const i=this.Vk(n);return s=i instanceof R,'Invalid response from provided "resolveUnknownLinks" function."resolveUnknownLinks" should return an instance of TwoStepsResponse',(u.user||(u.user=c()),void u.user.win?u.userForEmbed||(u.userForEmbed=c()):u.user).assert(s,'Invalid response from provided "resolveUnknownLinks" function."resolveUnknownLinks" should return an instance of TwoStepsResponse',undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined),i.syncResponse&&this.Ok.updateReplacementUrls(i.syncResponse),i.asyncResponse?i.asyncResponse.then((t=>{this.Ok.updateReplacementUrls(t)})):a();var s}Sk(t){const n=[];return t.forEach((t=>{this.isWatchingLink(t)||n.push(t)})),n}xk(){const t=this.Rc.querySelectorAll(this.Uk);return[].slice.call(t)}}(this.Rc,t,n,i);return this.Nk(this.Ek,s,this.Rk),s.onDomUpdated(),s}maybeRewriteLink(t,n){const i=this.Ck(t);if(i.length){let s=null;for(let n=0;n<i.length;n++)if(i[n].rewriteAnchorUrl(t)){s=i[n];break}const e={linkRewriterId:s?s.id:null,anchor:t,clickType:n.type};i.forEach((t=>{const n={type:"CLICK",eventData:e};t.events.fire(n)}))}}bk(t){const n=t.getMetaByName("amp-link-rewriter-priorities");return n?n.trim().split(/\s+/):[]}Mk(t){t.addEventListener("amp:dom-update",this.Dk.bind(this))}Dk(){this.Ek.forEach((t=>{t.onDomUpdated()}))}qk(t){const n=t.hasAttribute("data-link-rewriters")?t.getAttribute("data-link-rewriters").trim():null;return n?n.split(/\s+/):[]}Nk(t,n,i){return t.push(n),t.sort(((t,n)=>{const s=i.indexOf(t.id),e=i.indexOf(n.id);return-1===s&&-1===e?0:-1===s?1:-1===e?-1:s>e?1:-1})),t}Ck(t){const n=this.qk(t);return this.Ek.reduce(((i,s)=>(s.isWatchingLink(t)&&this.Nk(i,s,n),i)),[])}}(this.OI),this.OI.whenReady().then((()=>t.getReferrerUrl())).then((t=>{this.RI=t,this.OI.whenFirstVisible().then((()=>{this.JU()}))}))}JU(){this.XU().then((t=>{t&&(this.GU.linkmateExpected=t.linkmate_enabled,this.GU.publisherID=t.publisher_id,this.YU(),this.KU=new class{constructor(t,n,i,s){this.NR=n,this.tq=i.exclusiveLinks,this.nq=i.publisherID,this.iq=i.linkAttribute,this.Lk=null,this.sq=null,this.i=s}runLinkmate(t){let n=null;const s=this.Lk&&!function(t,n,s=5){if(!isFinite(s)||s<0)throw new Error("Invalid depth: "+s);if(t===n)return!0;const e=[{a:t,b:n,depth:s}];for(;e.length>0;){const{a:t,b:n,depth:s}=e.shift();if(s>0){if(typeof t!=typeof n)return!1;if(i(t)&&i(n)){if(t.length!==n.length)return!1;for(let i=0;i<t.length;i++)e.push({a:t[i],b:n[i],depth:s-1});continue}if(t&&n&&"object"==typeof t&&"object"==typeof n){const i=Object.keys(t),r=Object.keys(n);if(i.length!==r.length)return!1;for(const r of i)e.push({a:t[r],b:n[r],depth:s-1});continue}}if(t!==n)return!1}return!0}(this.Lk,t);if(this.sq&&s&&(n=this.eq()),!this.sq||s){const i=this.rq(t).then((n=>(this.sq=T(n)[0].smart_links,this.Lk=t,this.eq())));return new R(n,i)}return this.Lk=t,new R(n,null)}rq(t){const n=this.oq(t),i={"article":this.hq(),"links":n},s=g.LINKMATE_ENDPOINT.replace(".pub_id.",this.nq.toString()),e={method:"POST",ampCors:!1,headers:{"Content-Type":"application/json"},body:i};return this.NR.fetchJson(s,e).then((t=>t.json()))}oq(t){const n=[];return t.forEach((t=>{const i=t.getAttribute(this.iq);if(/shop-links.co/.test(i))/\?amp=true$/.test(i)||(t[this.iq]=`${t[this.iq]}?amp=true`);else if(!/#donotlink$/.test(i)){const t={"raw_url":i,"exclusive_match_requested":this.tq||/#locklink$/.test(i),"link_source":"linkmate"};n.push(t)}})),n}hq(){return{"name":this.uq(),"url":this.cq()}}uq(){let t=null;return this.i.document.getElementsByTagName("title").length>0&&(t=this.i.document.getElementsByTagName("title")[0].text),t}cq(){return this.i.location.href}eq(){const t=[];return this.Lk.forEach((n=>{this.sq.forEach((i=>{n.getAttribute(this.iq)===i.url&&i.auction_id&&t.push({anchor:n,replacementUrl:`https://shop-links.co/${i.auction_id}/?amp=true`})}))})),t}}(this.OI,this.NR,this.GU,this.win),this.qU=this.lq(),this.GU.linkmateEnabled&&this.GU.linkmateExpected&&this.qU.getAnchorReplacementList())}))}XU(){const t=g.NRTV_CONFIG_ENDPOINT.replace(".nrtv_slug.",this.GU.nrtvSlug);try{return this.NR.fetchJson(t,{method:"GET",ampCors:!1}).then((t=>t.json())).then((t=>T(t)[0].amp_config))}catch(t){return null}}YU(){this.signals().signal(n);const t=this.aq(),s=new class{constructor(t){this.qt=t,this.KI={"requests":{},"triggers":{}}}setTransportConfig(t){this.KI.transport=t}setExtraUrlParams(t){this.KI.extraUrlParams=t}track(t,n){n=i(n)?n:[n],l(!this.KI.triggers[t]);const s=[];for(let i=0;i<n.length;i++){const e=`${t}-request-${i}`;this.KI.requests[e]=n[i],s.push(e)}return this.KI.triggers[t]={"on":t,"request":s},this}build(){l(this.KI);const t=new class{constructor(t,i){l(i.triggers),this.di=t.getResourceId(),this.qt=t,this.KI=i;for(const t in i.triggers){const n=i.triggers[t].on;l(n);const s=this.QI(n);i.triggers[t].on=s}this.qt.signals().whenSignal(n).then((()=>{!function(t,n,i=!1,s=!1){const e=t.ownerDocument,h=o(e,"amp-analytics",{"sandbox":"true","trigger":s?"":"immediate"}),u=o(e,"script",{"type":"application/json"});if(u.textContent=JSON.stringify(n),h.appendChild(u),h.CONFIG=n,i){const n=_(r(t),"extensions"),i=P(t);n.installExtensionForDoc(i,"amp-analytics")}else I(t).then((t=>{l(t)}));t.appendChild(h)}(this.qt,i,!0)}))}trigger(t,n){l(this.KI.triggers[t]),function(t,n,i={},s=!0){I(t).then((e=>{e&&e.triggerEventForTarget(t,n,i,s)}))}(this.qt,this.QI(t),n,!1)}QI(t){return`sandbox-${this.di}-${t}`}}(this.qt,this.KI);return this.KI=null,t}}(this.element);s.track("page-impression",g.PAGE_IMPRESSION_ENDPOINT),s.setTransportConfig({"beacon":!0,"image":!1,"xhrpost":!0,"useBody":!0}),s.setExtraUrlParams(t),s.build().trigger("page-impression")}lq(){const t={linkSelector:this.GU.linkSelector};return this.Ak.registerLinkRewriter("amp-smartlinks",(t=>this.KU.runLinkmate(t)),t)}aq(){return{"events":[{"is_amp":!0}],"organization_id":this.GU.publisherID,"organization_type":"publisher","user":{"page_session_uuid":this._q(),"source_url":this.cq(),"previous_url":this.RI,"user_agent":this.OI.win.navigator.userAgent}}}cq(){return this.win.location.href}_q(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)))}};t.registerElement("amp-smartlinks",G)})();
/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */}});
//# sourceMappingURL=amp-smartlinks-0.1.mjs.map