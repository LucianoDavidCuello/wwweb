;
(self.AMP=self.AMP||[]).push({m:1,v:"2205120110001",n:"amp-subscriptions",ev:"0.1",l:!0,f:function(t,s){(()=>{var s;function i(){return s||(s=Promise.resolve(void 0))}var e=class{constructor(){this.promise=new Promise(((t,s)=>{this.resolve=t,this.reject=s}))}},{hasOwnProperty:n,toString:r}=Object.prototype;function o(t){const s=Object.create(null);return t&&Object.assign(s,t),s}function h(t,s){return n.call(t,s)}function c(t,s){if("."==s)return t;const i=s.split(".");let e=t;for(const t of i){if(!(t&&e&&void 0!==e[t]&&"object"==typeof e&&h(e,t))){e=void 0;break}e=e[t]}return e}var{isArray:u}=Array;function l(t){return JSON.parse(t)}function a(t,s){try{return l(t)}catch(t){return null==s||s(t),null}}function f(t,s,i,e,n,r,o,h,c,u,l){return t}function d(t){return(t.ownerDocument||t).defaultView}function p(t,s,i){return function(t,s){for(const i in s)t.setAttribute(i,s[i]);return t}(t.createElement(s),i)}var m=/(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;function g(t,s=""){try{return decodeURIComponent(t)}catch(t){return s}}self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var b=self.__AMP_LOG;function _(t,s){throw new Error("failed to call initLogConstructor")}function P(t){return b.user||(b.user=A()),function(t,s){return s&&s.ownerDocument.defaultView!=t}(b.user.win,t)?b.userForEmbed||(b.userForEmbed=A()):b.user}function A(t){return _()}function y(){return b.dev||(b.dev=_())}function v(t,s,i,e,n,r,o,h,c,u,l){return t}function E(t,s,i,e,n,r,o,h,c,u,l){return P().assert(t,s,i,e,n,r,o,h,c,u,l)}function w(t,s){return M(t=function(t){return t.__AMP_TOP||(t.__AMP_TOP=t)}(t),s)}function R(t,s){return M(k(S(t)),s)}function I(t,s){return function(t,s){const i=V(t,s);if(i)return i;const n=x(t);return n[s]=function(){const t=new e,{promise:s,reject:i,resolve:n}=t;return s.catch((()=>{})),{obj:null,promise:s,resolve:n,reject:i,context:null,ctor:null}}(),n[s].promise}(k(t),s)}function T(t,s){return V(k(t),s)}function S(t){return t.nodeType?(s=d(t),w(s,"ampdoc")).getAmpDoc(t):t;var s}function k(t){const s=S(t);return s.isSingleDoc()?s.win:s}function M(t,s){v(O(t,s));const i=x(t)[s];return i.obj||(v(i.ctor),v(i.context),i.obj=new i.ctor(i.context),v(i.obj),i.context=null,i.resolve&&i.resolve(i.obj)),i.obj}function V(t,s){const i=x(t)[s];return i?i.promise?i.promise:(M(t,s),i.promise=Promise.resolve(i.obj)):null}function x(t){let s=t.__AMP_SERVICES;return s||(s=t.__AMP_SERVICES={}),s}function O(t,s){const i=t.__AMP_SERVICES&&t.__AMP_SERVICES[s];return!(!i||!i.ctor)}var C=t=>M(t,"timer"),L=t=>R(t,"viewer"),U=t=>R(t,"viewport");function D(t){const s=function(t){return t.readyState}(t);return"loading"!=s&&"uninitialized"!=s}var N=class{constructor(t,s){let i,e,n;const r=t.indexOf(":");-1!=r?(e=t,i=e.substring(0,r),n=e.substring(r+1)):(i=t,e=null,n=null),this.publicationId_=i,this.productId_=e,this.label_=n,this.locked_=s}getPublicationId(){return this.publicationId_}getProductId(){return this.productId_}getLabel(){return this.label_}isLocked(){return this.locked_}};function j(t){console.log.apply(console,arguments)}function F(t,s){let i=t;do{if(i.nextSibling)return!0}while((i=i.parentNode)&&i!=s);return!1}function $(t){const s=Object.getOwnPropertyDescriptor(t,"message");if(s&&s.writable)return t;const{message:i,stack:e}=t,n=new Error(i);for(const s in t)n[s]=t[s];return n.stack=e,n}function z(t){let s=null,i="";for(let t=0;t<arguments.length;t++){const e=arguments[t];e instanceof Error&&!s?s=$(e):(i&&(i+=" "),i+=e)}return s?i&&(s.message=i+": "+s.message):s=new Error(i),s}var K=class{constructor(t=""){this.suffix_=t}prepareError_(t){this.suffix_&&(t.message?-1===t.message.indexOf(this.suffix_)&&(t.message=this.suffix_):t.message=this.suffix_)}createError(t){const s=z.apply(null,Array.prototype.slice.call(arguments));return this.prepareError_(s),s}createExpectedError(t){const s=z.apply(null,Array.prototype.slice.call(arguments));return this.prepareError_(s),s.expected=!0,s}error(t){throw this.createError.apply(this,arguments)}expectedError(t){throw this.createExpectedError.apply(this,arguments)}},G=new K(self.__AMP_TOP?"​​​":"");new K;var B="__SWG-SEEN__",W=["CreativeWork","Article","NewsArticle","Blog","Comment","Course","HowTo","Message","Review","WebPage"],J=new RegExp(W.join("|")),Y=class{constructor(){}checkValue(t,s){return!!t&&this.checkArray(this.toArray_(t),s)}checkString(t,s){return!!t&&this.checkArray(t.split(/\s+/),s)}checkArray(t,s){for(const i of t){const t=i.replace(/^http:\/\/schema.org\//i,"");if(s.includes(t))return!0}return!1}toArray_(t){return Array.isArray(t)?t:[t]}};function H(t,s){const i=t.querySelector(`meta[name="${s}"]`);return i?i.getAttribute("content"):null}function Q(t,s,i){return s in t?Object.defineProperty(t,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[s]=i,t}function Z(t,s){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var e=Object.getOwnPropertySymbols(t);s&&(e=e.filter((function(s){return Object.getOwnPropertyDescriptor(t,s).enumerable}))),i.push.apply(i,e)}return i}function X(t){for(var s=1;s<arguments.length;s++){var i=null!=arguments[s]?arguments[s]:{};s%2?Z(Object(i),!0).forEach((function(s){Q(t,s,i[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Z(Object(i)).forEach((function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(i,s))}))}return t}var q="subscriptions-action",tt="started",st={IS_READY_TO_PAY:"isReadyToPay",SUPPORTS_VIEWER:"supportsViewer"},it={};function et(t){if("undefined"!=typeof TextDecoder)return new TextDecoder("utf-8").decode(t);const s=function(t){const s=new Array(t.length);for(let i=0;i<t.length;i++)s[i]=String.fromCharCode(t[i]);return s.join("")}(new Uint8Array(t.buffer||t));return decodeURIComponent(escape(s))}function nt(t){const s=new Uint8Array(t.length);for(let i=0;i<t.length;i++){const e=t.charCodeAt(i);f(e<=255),s[i]=e}return s}function rt(t){return"function"==typeof t.then?t:new Promise(((s,i)=>{t.oncomplete=i=>{s(t.result)},t.onerror=i}))}function ot(t){const s=atob(t),i=s.length,e=new Uint8Array(i);for(let t=0;t<i;t++)e[t]=s.charCodeAt(t);return e}var ht,ct=["Webkit","webkit","Moz","moz","ms","O","o"];function ut(t){const s=t.replace(/[A-Z]/g,(t=>"-"+t.toLowerCase()));return ct.some((t=>s.startsWith(t+"-")))?`-${s}`:s}function lt(t,s,i){if(s.startsWith("--"))return s;ht||(ht=o());let e=ht[s];if(!e||i){if(e=s,void 0===t[s]){const i=function(t){return t.charAt(0).toUpperCase()+t.slice(1)}(s),n=function(t,s){for(let i=0;i<ct.length;i++){const e=ct[i]+s;if(void 0!==t[e])return e}return""}(t,i);void 0!==t[n]&&(e=n)}i||(ht[s]=e)}return e}function at(t,s){const{style:i}=t;for(const t in s)i.setProperty(ut(lt(i,t)),String(s[t]),"important")}function ft(t,s){void 0===s&&(s=t.hasAttribute("hidden")),s?t.removeAttribute("hidden"):t.setAttribute("hidden","")}var dt,pt,mt="SUBSCRIBER",gt="METERING",bt="UNLOCKED",_t=class{static empty(t){return new _t({source:"",raw:"",service:t,granted:!1})}constructor(t){const{dataObject:s,decryptedDocumentKey:i,grantReason:e="",granted:n=!1,raw:r="",service:o,source:h}=t;this.raw=r,this.source=h,this.service=o,this.granted=n,this.grantReason=e,this.data=s,this.decryptedDocumentKey=i}json(){return{"source":this.source,"service":this.service,"granted":this.granted,"grantReason":this.grantReason,"data":this.data}}jsonForPingback(){return X({"raw":this.raw},this.json())}static parseFromJson(t,s=null){t||(t={});const i=s||JSON.stringify(t),e=t.source||"",n=t.granted||!1,r=t.grantReason,o=t.data||null,h=t.decryptedDocumentKey||null;return new _t({source:e,raw:i,service:"",granted:n,grantReason:r,dataObject:o,decryptedDocumentKey:h})}isSubscriber(){return this.granted&&this.grantReason===mt}isFree(){return this.granted&&this.grantReason===bt}},Pt=(()=>self.AMP.config.urls)(),At=new Set(["c","v","a","ad"]),yt=t=>"string"==typeof t?Et(t):t;function vt(t){return t.origin||Et(t.location.href).origin}function Et(t,s){return dt||(dt=self.document.createElement("a")),function(t,s,i){return t.href="",new URL(s,t.href)}(dt,t)}function wt(t,s,i,e){return function(t,s,i){if(!s)return t;const e=t.split("#",2),n=e[0].split("?",2);let r=n[0]+(n[1]?i?`?${s}&${n[1]}`:`?${n[1]}&${s}`:`?${s}`);return r+=e[1]?`#${e[1]}`:"",r}(t,function(t,s){return`${encodeURIComponent(t)}=${encodeURIComponent(s)}`}(s,i),e)}function Rt(t,s,i="source"){var e;return E(null!=t,"%s %s must be available",s,i),E("https:"==(e=yt(e=t)).protocol||"localhost"==e.hostname||"127.0.0.1"==e.hostname||function(t,s){const i=t.length-s.length;return i>=0&&t.indexOf(s,i)==i}(e.hostname,".localhost")||/^\/\//.test(t),'%s %s must start with "https://" or "//" or be relative and served from either https or from localhost. Invalid value: %s',s,i,t),t}function It(t,s,i,e){let n=t,r=i,o=t=>{try{return r(t)}catch(t){var s,i;throw null===(s=(i=self).__AMP_REPORT_ERROR)||void 0===s||s.call(i,t),t}};const h=function(){if(void 0!==pt)return pt;pt=!1;try{const t={get capture(){return pt=!0,!1}};self.addEventListener("test-options",null,t),self.removeEventListener("test-options",null,t)}catch(t){}return pt}(),c=!(null==e||!e.capture);return n.addEventListener(s,o,h?e:c),()=>{null==n||n.removeEventListener(s,o,h?e:c),r=null,n=null,o=null}}function Tt(t){return t.data}function St(t,s,i,e){let n;try{n=t.open(s,i,e)}catch(t){y().error("DOM","Failed to open url on target: ",i,t)}var r,o;return!n&&"_top"!=i&&("number"!=typeof o&&(o=0),o+"noopener".length>(r=e||"").length||-1===r.indexOf("noopener",o))&&(n=t.open(s,"_top")),n}var kt=(()=>self.AMP.config.urls)(),Mt=new RegExp("RETURN_URL");function Vt(t,s){return function(t,s){const i=L(t);return parseInt(t.getParam("dialog"),10)?new xt(i,s):new Ot(t.win,i,s)}(t,s).open()}var xt=class{constructor(t,s){this.viewer=t,this.urlOrPromise=s}getLoginUrl(){let t;return t="string"==typeof this.urlOrPromise?Promise.resolve(this.urlOrPromise):this.urlOrPromise,t.then((t=>Ct(t,"RETURN_URL")))}open(){return this.getLoginUrl().then((t=>this.viewer.sendMessageAwaitResponse("openDialog",{"url":t})))}},Ot=class{constructor(t,s,i){this.win=t,this.viewer=s,this.urlOrPromise=i,this.te=null,this.Ar=null,this.dAt=null,this.pAt=null,this._At=null,this.mAt=null}open(){return E(!this.te,"Dialog already opened"),new Promise(((t,s)=>{this.te=t,this.Ar=s,this.AAt()})).then((t=>(this.Rn(),t)),(t=>{throw this.Rn(),t}))}Rn(){if(this.te=null,this.Ar=null,this.dAt){try{this.dAt.close()}catch(t){}this.dAt=null}this._At&&(this.win.clearInterval(this._At),this._At=null),this.mAt&&(this.mAt(),this.mAt=null)}getLoginUrl(){let t;return t="string"==typeof this.urlOrPromise?Promise.resolve(this.urlOrPromise):this.urlOrPromise,t.then((t=>Ct(t,this.PAt())))}AAt(){const{screen:t}=this.win,s=Math.floor(Math.min(700,.9*t.width)),e=Math.floor(Math.min(450,.9*t.height)),n=`height=${e},width=${s},left=${Math.floor((t.width-s)/2)},top=${Math.floor((t.height-e)/2)},resizable=yes,scrollbars=yes`,r=this.PAt();if(this.pAt=null,"string"==typeof this.urlOrPromise){const t=Ct(this.urlOrPromise,r);this.dAt=St(this.win,t,"_blank",n),this.dAt&&(this.pAt=i())}else this.dAt=St(this.win,"","_blank",n),this.dAt&&(this.pAt=this.urlOrPromise.then((t=>{const s=Ct(t,r);this.dAt.location.replace(s)}),(t=>{throw new Error("failed to resolve url: "+t)})));this.pAt?this.pAt.then((()=>{this.vAt(r)}),(t=>{this.gAt(null,t)})):this.gAt(null,new Error("failed to open dialog"))}vAt(t){const s=Et(t).origin;this._At=this.win.setInterval((()=>{this.dAt.closed&&(this.win.clearInterval(this._At),this._At=null,this.win.setTimeout((()=>{this.gAt("")}),3e3))}),500),this.mAt=It(this.win,"message",(t=>{t.origin==s&&Tt(t)&&"amp"==Tt(t).sentinel&&"result"==Tt(t).type&&(this.dAt&&this.dAt.postMessage({"sentinel":"amp","type":"result-ack"},s),this.gAt(Tt(t).result))}),void 0)}gAt(t,s){this.te&&(s?this.Ar(s):this.te(t),this.Rn())}PAt(){const t=this.viewer.getResolvedViewerUrl();let s;return s=`${kt.cdn}/v0/amp-login-done-0.1.html`,s+"?url="+encodeURIComponent(t)}};function Ct(t,s){return Mt.test(t)?t.replace(Mt,encodeURIComponent(s)):t+(-1==t.indexOf("?")?"?":"&")+"return="+encodeURIComponent(s)}var Lt="local",Ut=function(){var t=function(t,s,i,e){for(i=i||{},e=t.length;e--;i[t[e]]=s);return i},s=[1,3],i=[1,4],e=[1,18],n=[1,19],r=[1,14],o=[1,15],h=[1,16],c=[1,17],u=[1,21],l=[1,22],a=[5,6,7,10],f=[5,6,7,10,15,16,17,18,19,20,21],d=[5,6,7,10,15,16,17,18,19,20,21,25,27],p={trace:function(){},yy:{},AW:{"error":2,"result":3,"search_condition":4,"EOF":5,"OR":6,"AND":7,"NOT":8,"(":9,")":10,"predicate":11,"comparison_predicate":12,"truthy_predicate":13,"scalar_exp":14,"EQ":15,"DEQ":16,"NEQ":17,"LT":18,"LTE":19,"GT":20,"GTE":21,"atom":22,"field_ref":23,"literal":24,"DOT":25,"field_name":26,"[":27,"string":28,"]":29,"NAME":30,"STRING":31,"NUMERIC":32,"TRUE":33,"FALSE":34,"NULL":35,"$accept":0,"$end":1},EW:{2:"error",5:"EOF",6:"OR",7:"AND",8:"NOT",9:"(",10:")",15:"EQ",16:"DEQ",17:"NEQ",18:"LT",19:"LTE",20:"GT",21:"GTE",25:"DOT",27:"[",29:"]",30:"NAME",31:"STRING",32:"NUMERIC",33:"TRUE",34:"FALSE",35:"NULL"},RW:[0,[3,2],[4,3],[4,3],[4,2],[4,3],[4,1],[11,1],[11,1],[12,3],[12,3],[12,3],[12,3],[12,3],[12,3],[12,3],[13,1],[14,1],[14,1],[22,1],[23,3],[23,4],[23,1],[26,1],[28,1],[24,1],[24,1],[24,1],[24,1],[24,1]],performAction:function(t,s,i,e,n,r,o){var h=r.length-1;switch(n){case 1:return r[h-1];case 2:this.$=r[h-2]||r[h];break;case 3:this.$=r[h-2]&&r[h];break;case 4:this.$=!r[h];break;case 5:this.$=r[h-1];break;case 6:case 7:case 8:case 17:case 18:case 19:this.$=r[h];break;case 9:this.$=r[h-2]===r[h];break;case 10:throw new Error('"==" is not allowed, use "="');case 11:this.$=r[h-2]!==r[h];break;case 12:this.$=typeof r[h-2]==typeof r[h]&&r[h-2]<r[h];break;case 13:this.$=typeof r[h-2]==typeof r[h]&&r[h-2]<=r[h];break;case 14:this.$=typeof r[h-2]==typeof r[h]&&r[h-2]>r[h];break;case 15:this.$=typeof r[h-2]==typeof r[h]&&r[h-2]>=r[h];break;case 16:this.$=void 0!==r[h]&&null!==r[h]&&""!==r[h]&&0!==r[h]&&!1!==r[h];break;case 20:this.$="[object Object]"==Object.prototype.toString.call(r[h-2])&&r[h-2].hasOwnProperty(r[h])?r[h-2][r[h]]:null;break;case 21:this.$="[object Object]"==Object.prototype.toString.call(r[h-3])&&r[h-3].hasOwnProperty(r[h-1])?r[h-3][r[h-1]]:null;break;case 22:this.$=void 0!==e[r[h]]?e[r[h]]:null;break;case 23:this.$=t;break;case 24:this.$=t.substring(1,t.length-1);break;case 26:this.$=Number(t);break;case 27:this.$=!0;break;case 28:this.$=!1;break;case 29:this.$=null}},table:[{3:1,4:2,8:s,9:i,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{1:[3]},{5:[1,20],6:u,7:l},{4:23,8:s,9:i,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{4:24,8:s,9:i,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},t(a,[2,6]),t(a,[2,7]),t(a,[2,8]),t(a,[2,16],{15:[1,25],16:[1,26],17:[1,27],18:[1,28],19:[1,29],20:[1,30],21:[1,31]}),t(f,[2,17]),t(f,[2,18],{25:[1,32],27:[1,33]}),t(f,[2,19]),t(d,[2,22]),t(f,[2,25]),t(f,[2,26]),t(f,[2,27]),t(f,[2,28]),t(f,[2,29]),t(d,[2,23]),t([5,6,7,10,15,16,17,18,19,20,21,29],[2,24]),{1:[2,1]},{4:34,8:s,9:i,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{4:35,8:s,9:i,11:5,12:6,13:7,14:8,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},t(a,[2,4]),{6:u,7:l,10:[1,36]},{14:37,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{14:38,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{14:39,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{14:40,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{14:41,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{14:42,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{14:43,22:9,23:10,24:11,26:12,28:13,30:e,31:n,32:r,33:o,34:h,35:c},{26:44,30:e},{28:45,31:n},t([5,6,10],[2,2],{7:l}),t(a,[2,3]),t(a,[2,5]),t(a,[2,9]),t(a,[2,10]),t(a,[2,11]),t(a,[2,12]),t(a,[2,13]),t(a,[2,14]),t(a,[2,15]),t(d,[2,20]),{29:[1,46]},t(d,[2,21])],defaultActions:{20:[2,1]},parseError:function(t,s){if(!s.recoverable){var i=new Error(t);throw i.hash=s,i}this.trace(t)},parse:function(t){var s=this,i=[0],e=[null],n=[],r=this.table,o="",h=0,c=0,u=0,l=2,a=1,f=n.slice.call(arguments,1),d=Object.create(this.lexer),p={yy:{}};for(var m in this.yy)Object.prototype.hasOwnProperty.call(this.yy,m)&&(p.yy[m]=this.yy[m]);d.setInput(t,p.yy),p.yy.lexer=d,p.yy.parser=this,void 0===d.yylloc&&(d.yylloc={});var g=d.yylloc;n.push(g);var b=d.options&&d.options.ranges;"function"==typeof p.yy.parseError?this.parseError=p.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var _,P,A,y,v,E,w,R,I,T=function(){var t;return"number"!=typeof(t=d.lex()||a)&&(t=s.AW[t]||t),t},S={};;){if(A=i[i.length-1],this.defaultActions[A]?y=this.defaultActions[A]:(null==_&&(_=T()),y=r[A]&&r[A][_]),void 0===y||!y.length||!y[0]){var k="";for(E in I=[],r[A])this.EW[E]&&E>l&&I.push("'"+this.EW[E]+"'");k=d.showPosition?"Parse error on line "+(h+1)+":\n"+d.showPosition()+"\nExpecting "+I.join(", ")+", got '"+(this.EW[_]||_)+"'":"Parse error on line "+(h+1)+": Unexpected "+(_==a?"end of input":"'"+(this.EW[_]||_)+"'"),this.parseError(k,{text:d.match,token:this.EW[_]||_,line:d.yylineno,loc:g,expected:I})}if(y[0]instanceof Array&&y.length>1)throw new Error("Parse Error: multiple actions possible at state: "+A+", token: "+_);switch(y[0]){case 1:i.push(_),e.push(d.yytext),n.push(d.yylloc),i.push(y[1]),_=null,P?(_=P,P=null):(c=d.yyleng,o=d.yytext,h=d.yylineno,g=d.yylloc,u>0&&u--);break;case 2:if(w=this.RW[y[1]][1],S.$=e[e.length-w],S._$={first_line:n[n.length-(w||1)].first_line,last_line:n[n.length-1].last_line,first_column:n[n.length-(w||1)].first_column,last_column:n[n.length-1].last_column},b&&(S._$.range=[n[n.length-(w||1)].range[0],n[n.length-1].range[1]]),void 0!==(v=this.performAction.apply(S,[o,c,h,p.yy,y[1],e,n].concat(f))))return v;w&&(i=i.slice(0,-1*w*2),e=e.slice(0,-1*w),n=n.slice(0,-1*w)),i.push(this.RW[y[1]][0]),e.push(S.$),n.push(S._$),R=r[i[i.length-2]][i[i.length-1]],i.push(R);break;case 3:return!0}}return!0}},m={EOF:1,parseError:function(t,s){if(!this.yy.parser)throw new Error(t);this.yy.parser.parseError(t,s)},setInput:function(t,s){return this.yy=s||this.yy||{},this._input=t,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var t=this._input[0];return this.yytext+=t,this.yyleng++,this.offset++,this.match+=t,this.matched+=t,t.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),t},unput:function(t){var s=t.length,i=t.split(/(?:\r\n?|\n)/g);this._input=t+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-s),this.offset-=s;var e=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),i.length-1&&(this.yylineno-=i.length-1);var n=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:i?(i.length===e.length?this.yylloc.first_column:0)+e[e.length-i.length].length-i[0].length:this.yylloc.first_column-s},this.options.ranges&&(this.yylloc.range=[n[0],n[0]+this.yyleng-s]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(t){this.unput(this.match.slice(t))},pastInput:function(){var t=this.matched.substr(0,this.matched.length-this.match.length);return(t.length>20?"...":"")+t.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var t=this.match;return t.length<20&&(t+=this._input.substr(0,20-t.length)),(t.substr(0,20)+(t.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var t=this.pastInput(),s=new Array(t.length+1).join("-");return t+this.upcomingInput()+"\n"+s+"^"},test_match:function(t,s){var i,e,n;if(this.options.backtrack_lexer&&(n={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(n.yylloc.range=this.yylloc.range.slice(0))),(e=t[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=e.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:e?e[e.length-1].length-e[e.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],i=this.performAction.call(this,this.yy,this,s,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),i)return i;if(this._backtrack){for(var r in n)this[r]=n[r];return!1}return!1},next:function(){if(this.done)return this.EOF;var t,s,i,e;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var n=this._currentRules(),r=0;r<n.length;r++)if((i=this._input.match(this.rules[n[r]]))&&(!s||i[0].length>s[0].length)){if(s=i,e=r,this.options.backtrack_lexer){if(!1!==(t=this.test_match(i,n[r])))return t;if(this._backtrack){s=!1;continue}return!1}if(!this.options.flex)break}return s?!1!==(t=this.test_match(s,n[e]))&&t:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){return this.next()||this.lex()},begin:function(t){this.conditionStack.push(t)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(t){return(t=this.conditionStack.length-1-Math.abs(t||0))>=0?this.conditionStack[t]:"INITIAL"},pushState:function(t){this.begin(t)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(t,s,i,e){switch(i){case 0:break;case 1:return 7;case 2:return 6;case 3:return 8;case 4:return 35;case 5:case 6:return 33;case 7:case 8:return 34;case 9:return 9;case 10:return 10;case 11:return 27;case 12:return 29;case 13:return"|";case 14:return 19;case 15:return 18;case 16:return 21;case 17:return 20;case 18:return 17;case 19:return 16;case 20:return 15;case 21:return 32;case 22:return 30;case 23:case 24:return 31;case 25:return 25;case 26:return"INVALID";case 27:return 5}},rules:[/^(?:\s+)/,/^(?:AND\b)/,/^(?:OR\b)/,/^(?:NOT\b)/,/^(?:NULL\b)/,/^(?:TRUE\b)/,/^(?:true\b)/,/^(?:FALSE\b)/,/^(?:false\b)/,/^(?:\()/,/^(?:\))/,/^(?:\[)/,/^(?:\])/,/^(?:\|)/,/^(?:<=)/,/^(?:<)/,/^(?:>=)/,/^(?:>)/,/^(?:!=)/,/^(?:==)/,/^(?:=)/,/^(?:-?[0-9]+(\.[0-9]+)?\b)/,/^(?:[a-zA-Z_][a-zA-Z0-9_]*)/,/^(?:'[^\']*')/,/^(?:"[^\"]*")/,/^(?:\.)/,/^(?:.)/,/^(?:$)/],conditions:{"INITIAL":{"rules":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27],"inclusive":!0}}};function g(){this.yy={}}return p.lexer=m,g.prototype=p,p.Parser=g,new g}(),Dt=Ut;function Nt(t,s){return function(t,s){try{return Dt.yy=s,!!Dt.parse(t)}finally{Dt.yy=null}}(t,s)}var jt="_AMP_SUBSCRIPTIONS_CLICK_HANDLED",Ft=class{constructor(t,s,i){this.Ni=t,this.Rc=t.getRootNode(),this.m9=s,this.Ugt=!!this.m9.pingbackAllEntitlements,this.Y8=i,this.s9=new class{constructor(t,s){const i=t.getHeadNode();this.Xy=function(t,s){const i=k(S(t));return O(i,s)?M(i,s):null}(i,"url-replace"),this.i9=s,this.o9=null}setAuthResponse(t){this.o9=t}buildUrl(t,s){return this.r9(s).then((s=>this.Xy.expandUrlAsync(t,s)))}collectUrlVars(t,s){return this.r9(s).then((s=>this.Xy.collectVars(t,s)))}r9(t){return this.i9.then((s=>{const i={"READER_ID":s,"ACCESS_READER_ID":s};return t&&(i.AUTHDATA=t=>{if(this.o9)return c(this.o9,t)}),i}))}}(this.Ni,this.Y8.getReaderId("local")),this.e9=i.getAnalytics(),E(this.m9.actions,"Actions have not been defined in the service config"),this.T_=new class{constructor(t,s,i,e){for(const t in e)Rt(e[t],`action ${t}`);this.Kgt=e,this.Ggt={},this.s9=s,this.BI=i,this.Bgt=null,this.Wgt=0,this.Jgt=Vt.bind(null,t),this.build()}build(){if(0==Object.keys(this.Kgt).length)return null;const t=[];for(const s in this.Kgt)t.push(this.s9.buildUrl(this.Kgt[s],!0).then((t=>{this.Ggt[s]=t})));return Promise.all(t).then((()=>this.Ggt))}execute(t){E(this.Kgt[t],"Action URL is not configured: %s",t);const s=E(this.Ggt[t],"Action URL is not ready: %s",t);return this.ls(s,t)}ls(t,s){const i=Date.now();if(this.Bgt&&i-this.Wgt<1e3)return this.Bgt;this.BI.actionEvent(Lt,s,tt);const e=this.Jgt(t).then((t=>{this.Bgt=null;const i=function(t){const s=o();if(!t)return s;let i;for(;i=m.exec(t);){const t=g(i[1],i[1]),e=i[2]?g(i[2].replace(/\+/g," "),i[2]):"";s[t]=e}return s}(t).success,e="true"==i||"yes"==i||"1"==i;return e?this.BI.actionEvent(Lt,s,"success"):this.BI.actionEvent(Lt,s,"rejected"),e||!i})).catch((t=>{throw this.BI.actionEvent(Lt,s,"failed"),this.Bgt==e&&(this.Bgt=null),t}));return this.Bgt=e,this.Wgt=i,this.Bgt}}(this.Ni,this.s9,this.e9,this.validateActionMap(this.m9.actions)),this.fg=new class{constructor(t,s,i){this.Ni=t,this.Rc=t.getRootNode(),this.dAt=s,this.tM=R(t,"templates"),this.Y8=i}render(t){return Promise.all([this.Ygt(t),this.Qgt(t)])}reset(){return this.dAt.close(),this.Zgt({},this.Rc,(()=>!1))}Ygt(t){this.Zgt(t,this.Rc,Nt)}Qgt(t){return this.Ni.whenReady().then((()=>{const s=this.Ni.getRootNode().querySelectorAll("[subscriptions-dialog][subscriptions-display]");for(let i=0;i<s.length;i++){const e=s[i],n=e.getAttribute("subscriptions-display");if(n&&Nt(n,t))return e}})).then((s=>{if(!s)return;if("TEMPLATE"==s.tagName)return this.tM.renderTemplate(s,t).then((s=>{const i=t;return this.Zgt(i,s,Nt)}));const i=s.cloneNode(!0);return i.removeAttribute("subscriptions-dialog"),i.removeAttribute("subscriptions-display"),i})).then((t=>{if(t)return this.dAt.open(t,!0)}))}Zgt(t,s,i){return this.Ni.whenReady().then((()=>{const e=s.querySelectorAll('[subscriptions-action], [subscriptions-section="actions"], [subscriptions-actions]');for(let s=0;s<e.length;s++){const n=e[s],r=n.getAttribute("subscriptions-display");r&&i(r,t)?(n.classList.add("i-amphtml-subs-display"),n.getAttribute("subscriptions-service")&&n.getAttribute("subscriptions-action")&&"false"!==n.getAttribute("subscriptions-decorate")&&!n.hasAttribute("i-amphtml-subs-decorated")&&(this.Y8.decorateServiceAction(n,n.getAttribute("subscriptions-service"),n.getAttribute("subscriptions-action"),null),n.setAttribute("i-amphtml-subs-decorated",!0))):n.classList.remove("i-amphtml-subs-display")}return s}))}}(this.Ni,i.getDialog(),this.Y8)}getPlatformKey(){return"local"}validateActionMap(t){return E(t.login,'Action "login" is not present in action map'),E(t.subscribe,'Action "subscribe" is not present in action map'),t}DV(){const t=t=>{if(t[jt])return;t[jt]=!0;const s=function(t,s){return t.closest("[subscriptions-action]")}(t.target);this.$c(s)};this.Rc.addEventListener("click",t),this.Rc.body&&this.Rc.body.addEventListener("click",t)}$c(t){if(t){const s=t.getAttribute("subscriptions-action"),i=t.getAttribute("subscriptions-service");if("local"==i)this.executeAction(s,t.id);else if("auto"==(i||"auto"))if("login"==s){const i=this.Y8.selectPlatformForLogin();this.Y8.delegateActionToService(s,i.getPlatformKey(),t.id)}else this.executeAction(s,t.id);else i&&this.Y8.delegateActionToService(s,i,t.id)}}activate(t){this.Xgt(t).then((t=>{this.fg.render(t)}))}Xgt(t){const s=t.json();return this.Y8.getScoreFactorStates().then((t=>(s.factors=t,this.s9.setAuthResponse(s)))).then((()=>this.T_.build())).then((()=>s))}reset(){this.fg.reset()}executeAction(t){return this.T_.execute(t).then((t=>(t&&this.Y8.resetPlatforms(),!!t)))}isPrerenderSafe(){return!1}getSupportedScoreFactor(t){return 0}getBaseScore(){return this.m9.baseScore||0}getEntitlements(){}pingback(t){}pingbackReturnsAllEntitlements(){return this.Ugt}isPingbackEnabled(){return!1}decorateUI(t,s,i){}},$t="__AMP__",zt=class extends Ft{constructor(t,s,i){super(t,s,i),v("iframe"==this.m9.type),this.ov=E(this.m9.iframeSrc,'"iframeSrc" URL must be specified'),Rt(this.ov,"iframe Url"),this.XAt=this.m9.iframeVars||null,this.XAt&&E(u(this.XAt),'"iframeVars" must be an array'),this.hb=Et(this.ov).origin,this.ZAt=null,this.tPt=null,this.eb=t.win.document.createElement("iframe"),ft(this.eb,!1),this.iPt=new class{constructor(t,s,i){this.i=t,this.sPt=s,this.hb=i,this.o=null,this.ePt=null,this.nPt=this.Fy.bind(this),this.rPt=0,this.oPt={}}connect(t){if(this.ePt)throw new Error("already connected");this.ePt=t,this.i.addEventListener("message",this.nPt)}disconnect(){this.ePt&&(this.ePt=null,this.i.removeEventListener("message",this.nPt))}isConnected(){return null!=this.hb}getTarget(){const t=this.hPt();if(!t)throw new Error("not connected");return t}hPt(){return this.ePt&&!this.o&&("function"==typeof this.sPt?this.o=this.sPt():this.o=this.sPt),this.o}getTargetOrigin(){if(null==this.hb)throw new Error("not connected");return this.hb}sendCommand(t,s){this.Ov(void 0,t,s)}sendCommandRsvp(t,s){const i=String(++this.rPt);let e=null;const n=new Promise((t=>{e=t}));return this.oPt[i]={promise:n,resolver:e},this.Ov(i,t,s),n}Ov(t,s,i){const e=this.getTarget(),n="connect"==s?null!=this.hb?this.hb:"*":this.getTargetOrigin();e.postMessage({"sentinel":$t,"_rsvp":t,"cmd":s,"payload":i||null},n)}Fy(t){const s=t,{data:i}=s;if(!i||i.sentinel!=$t)return;const e=s.origin,n=i.cmd,r=i.payload||null;if(null==this.hb&&"start"==n&&(this.hb=e),null==this.hb&&s.source&&this.hPt()==s.source&&(this.hb=e),e!=this.hb)return;const o=i._rsvp,h=!!o&&"rsvp"!=n,c=this.cPt(o,n,r);h&&Promise.resolve(c).then((t=>{this.Ov(o,"rsvp",{"result":t})}),(t=>{this.Ov(o,"rsvp",{"error":String(t)})}))}cPt(t,s,i){if("rsvp"!=s)return this.ePt(s,i);{const s=t&&this.oPt[t];s&&("error"in i?s.resolver(Promise.reject(new Error(i.error))):s.resolver(i.result),delete this.oPt[t])}}}(this.Ni.win,(()=>this.eb.contentWindow),this.hb),this.Qb=null,this.DV()}getEntitlements(){return this.connect().then((()=>this.iPt.sendCommandRsvp("authorize",{}).then((t=>(t.source="local-iframe",t))).then((t=>_t.parseFromJson(t)))))}isPingbackEnabled(){return!0}pingback(t){return this.connect().then((()=>this.iPt.sendCommandRsvp("pingback",{entitlement:t})))}connect(){if(!this.tPt){const t=new e;this.tPt=t.promise,this.ZAt=t.resolve,this.Qb=this.fPt(),this.iPt.connect(this.cPt.bind(this)),this.Ni.getBody().appendChild(this.eb),this.eb.src=this.ov}return this.tPt}fPt(){return new Promise((t=>{const s=l(JSON.stringify(this.m9)),i=this.Y8.getPageConfig();if(s.pageConfig={publicationId:i.getPublicationId(),productId:i.getProductId(),encryptedDocumentKey:this.Y8.getEncryptedDocumentKey("local")||null},this.XAt){const i=this.XAt.join("&");this.s9.collectUrlVars(i,!1).then((i=>{s.iframeVars=i,t(s)}))}else t(s)}))}cPt(t,s){"connect"===t&&this.Qb.then((t=>{this.iPt.sendCommandRsvp("start",{"protocol":"amp-subscriptions","config":t}).then((()=>{this.ZAt&&(this.ZAt(),this.ZAt=null)}))}))}},Kt=class extends Ft{constructor(t,s,i){super(t,s,i),this.dut=Rt(E(this.m9.authorizationUrl,"Service config does not have authorization Url"),"Authorization Url"),this.NR=w(this.Ni.win,"xhr"),this.Aut=this.m9.pingbackUrl||null,this.DV()}getEntitlements(){const t=this.s9.buildUrl(this.dut,!1),s=this.Y8.loadMeteringState();return Promise.all([t,s]).then((t=>{let s=t[0];const i=t[1];i&&(s=wt(s,"meteringState",btoa(JSON.stringify(i))));const e=this.Y8.getEncryptedDocumentKey("local");return e&&(s=wt(s,"crypt",e)),this.NR.fetchJson(s,{credentials:"include"}).then((t=>t.json())).then((t=>{const s=[];return t.metering&&t.metering.state&&s.push(this.Y8.saveMeteringState(t.metering.state)),Promise.all(s).then((()=>_t.parseFromJson(t)))}))}))}isPingbackEnabled(){return!!this.Aut}qgt(t){if(u(t)){const s=[];return t.forEach((t=>{s.push(t.jsonForPingback())})),JSON.stringify(s)}return JSON.stringify(t.jsonForPingback())}pingback(t){if(!this.isPingbackEnabled)return;const s=v(this.Aut);return this.s9.buildUrl(s,!0).then((s=>this.NR.sendSignal(s,{method:"POST",credentials:"include",headers:{"Content-Type":"text/plain"},body:this.qgt(t)})))}};function Gt(t,s,i){return"iframe"===s.type?new zt(t,s,i):new Kt(t,s,i)}var Bt=class{constructor(){this.St=null}add(t){return this.St||(this.St=[]),this.St.push(t),()=>{this.remove(t)}}remove(t){this.St&&function(t,s){const i=t.indexOf(s);-1!=i&&t.splice(i,1)}(this.St,t)}removeAll(){this.St&&(this.St.length=0)}fire(t){if(this.St)for(const s of this.St.slice())s(t)}getHandlerCount(){var t,s;return null!==(t=null===(s=this.St)||void 0===s?void 0:s.length)&&void 0!==t?t:0}},Wt=class{constructor(t,s,i,n,r){this.sbt=n||{},this.ibt=t,this.nbt={},this.rbt={},t.forEach((t=>{this.rbt[t]=new e})),this.obt=new Bt,this.hbt=new Bt,this.cbt=null,this.ubt=null,this.lbt=null,this.abt=null,this.fbt=[],this.dbt=i,this.pbt=Object.assign(it,s),this.mbt=r||new Bt}resolvePlatform(t,s){this.sbt[t]=s,this.hbt.fire({platformKey:t})}resetPlatformStore(){for(const t in this.sbt)this.sbt[t].reset();return new Wt(this.ibt,this.pbt,this.dbt,this.sbt,this.mbt)}resetPlatform(t){delete this.nbt[t],this.rbt[t]=new e,this.sbt[t].reset(),this.cbt=null,this.ubt=null,this.lbt=null,this.abt=null}onPlatformResolves(t,s){const i=this.sbt[t];i?s(i):this.hbt.add((i=>{i.platformKey===t&&s(this.getPlatform(t))}))}getPlatform(t){const s=this.sbt[t];return v(s),s}gbt(){return this.getPlatform("local")}getAvailablePlatforms(){const t=[];for(const s in this.sbt){const i=this.sbt[s];t.push(i)}return t}onChange(t){this.obt.add(t)}addOnEntitlementResolvedCallback(t){this.mbt.add(t)}resolveEntitlement(t,s){s&&(s.service=t),this.nbt[t]=s;const i=this.rbt[t];i&&i.resolve(s),-1!==this.fbt.indexOf(t)&&this.fbt.splice(this.fbt.indexOf(t),1),s.granted&&this.bbt(s),this.obt.fire({platformKey:t,entitlement:s}),this.mbt.fire({platformKey:t,entitlement:s})}getResolvedEntitlementFor(t){return v(this.nbt[t]),this.nbt[t]}getEntitlementPromiseFor(t){return v(this.rbt[t]),this.rbt[t].promise}getScoreFactorStates(){const t={};return Promise.all(this.ibt.map((s=>(t[s]={},Promise.all(Object.values(st).map((i=>this._bt(s,i).then((e=>{t[s][i]=e}))))))))).then((()=>t))}_bt(t,s){return this.getEntitlementPromiseFor(t).then((()=>this.sbt[t].getSupportedScoreFactor(s)))}getGrantStatus(){if(null!==this.cbt)return this.cbt.promise;this.cbt=new e;for(const t in this.nbt){const s=this.nbt[t];s.granted&&(this.bbt(s),this.cbt.resolve(!0))}return this.Pbt()?this.cbt.resolve(!1):this.onChange((t=>{const{entitlement:s}=t;s.granted?this.cbt.resolve(!0):this.Pbt()&&this.cbt.resolve(!1)})),this.cbt.promise}bbt(t){(!this.ubt&&t.granted||this.ubt&&!this.ubt.isSubscriber()&&t.isSubscriber())&&(this.ubt=t)}getGrantEntitlement(){const t=()=>this.ubt&&(this.ubt.isSubscriber()||this.ubt.isFree()),s=()=>t()||this.Pbt();return this.lbt||(this.lbt=new e,s()?this.lbt.resolve(this.ubt):this.obt.add((()=>{s()&&this.lbt.resolve(this.ubt)}))),this.lbt.promise}reset(){this.cbt=null}getAllPlatformsEntitlements(){return this.abt||(this.abt=new e,this.Pbt()?this.abt.resolve(this.Abt()):this.onChange((()=>{this.Pbt()&&this.abt.resolve(this.Abt())}))),this.abt.promise}Abt(){const t=[];for(const s in this.nbt)h(this.nbt,s)&&t.push(this.nbt[s]);return t}selectPlatform(){return this.getAllPlatformsEntitlements().then((()=>this.ybt()))}Pbt(){return Object.keys(this.nbt).length===this.ibt.length}vbt(t,s){const i=s.getSupportedScoreFactor(t);return"number"!=typeof i?0:this.pbt[t]*Math.min(1,Math.max(-1,i))}ybt(){v(this.Pbt());const t=this.getAvailablePlatforms();for(;t.length;){const s=t.pop(),i=this.getResolvedEntitlementFor(s.getPlatformKey());if(i.isSubscriber()||i.isFree())return s}return this.Ebt(this.wbt())}wbt(){return this.getAvailablePlatforms().map((t=>({platform:t,weight:this.Rbt(t)})))}Rbt(t){const s=[0],i=t.getBaseScore();for(const i in this.pbt)h(this.pbt,i)&&s.push(this.vbt(i,t));return i+s.reduce(((t,s)=>t+s))}Ebt(t){const s=this.gbt();return t.sort(((t,i)=>i.weight===t.weight&&t.platform===s?-1:i.weight-t.weight)),t[0].platform}Ibt(t){const s=this.getAvailablePlatforms().map((s=>{const i=s.getSupportedScoreFactor(t);return{platform:s,weight:"number"==typeof i?i:0}}));return this.Ebt(s)}reportPlatformFailureAndFallback(t){if(t===this.gbt().getPlatformKey()&&this.dbt)this.resolveEntitlement(this.gbt().getPlatformKey(),this.dbt);else if(-1===this.fbt.indexOf(t)){const s=_t.empty(t);this.resolveEntitlement(t,s),this.fbt.push(t)}}selectPlatformForLogin(){return this.Ibt(st.SUPPORTS_VIEWER)}},Jt="i-amphtml-subs",Yt={"-":"+","_":"/",".":"="};function Ht(t){return nt(atob(t.replace(/[-_.]/g,(t=>Yt[t]))))}function Qt(t,s,i){if(s[i])return s[i];const e=t.querySelector(`style[${i}], link[${i}]`);return e?(s[i]=e,e):null}function Zt(t,s){const i=t.styleSheets;for(let t=0;t<i.length;t++)if(i[t].ownerNode==s)return!0;return!1}var Xt=self.__AMP_ERRORS||[];self.__AMP_ERRORS=Xt;var qt="amp-subscriptions";t.registerServiceForDoc("subscriptions",(function(t){return new class{constructor(t){const s=t.getElementById(qt);this.Ni=t,function(t,s,i,e,n){const r=t.getHeadNode(),h=function(t,s,i,e){let n=t.__AMP_CSS_SM;n||(n=t.__AMP_CSS_SM=o());const r=`amp-extension=${e}`;if(r){const i=Qt(t,n,r);if(i)return"STYLE"==i.tagName&&i.textContent!==s&&(i.textContent=s),i}const h=(t.ownerDocument||t).createElement("style");h.textContent=s;let c=null;return h.setAttribute("amp-extension",e),c=Qt(t,n,"amp-runtime"),function(t,s,i=null){if(!i)return void function(t,s){t.insertBefore(s,t.firstChild)}(t,s);const e=i.nextSibling;t.insertBefore(s,e)}(t,h,c),r&&(n[r]=h),h}(r,function(t,s){const i=t.__AMP_CSS_TR;return i?i(s):s}(r,'[subscriptions-action]:not(.i-amphtml-subs-display),[subscriptions-actions]:not(.i-amphtml-subs-display),[subscriptions-section=actions]:not(.i-amphtml-subs-display),body.i-amphtml-subs-delegated [subscriptions-section=actions],body.i-amphtml-subs-grant-unk [subscriptions-action],body.i-amphtml-subs-grant-unk [subscriptions-section=actions],body:not(.i-amphtml-subs-grant-no) [subscriptions-section=content-not-granted],body:not(.i-amphtml-subs-grant-yes) [subscriptions-section=content],body:not(.i-amphtml-subs-loading) [subscriptions-section=loading]{display:none!important}amp-subscriptions-dialog{display:block!important;position:fixed!important;bottom:0!important;left:0!important;margin-left:0!important;width:100%!important;z-index:2147483641!important;max-height:90vh;box-sizing:border-box;opacity:1;background-image:none;background-color:#fff;box-shadow:0 0 5px 0 rgba(0,0,0,0.2);margin-bottom:0;transition:transform 0.3s ease-in}.i-amphtml-subs-dialog-close-button{position:absolute;width:28px;height:28px;top:-28px;right:0;background-image:url(\'data:image/svg+xml;charset=utf-8,<svg width="13" height="13" viewBox="341 8 13 13" xmlns="http://www.w3.org/2000/svg"><path fill="%234F4F4F" d="M354 9.31 352.69 8l-5.19 5.19L342.31 8 341 9.31l5.19 5.19-5.19 5.19 1.31 1.31 5.19-5.19 5.19 5.19 1.31-1.31-5.19-5.19z" fill-rule="evenodd"/></svg>\');background-size:13px 13px;background-position:9px;background-color:#fff;background-repeat:no-repeat;box-shadow:0 -1px 1px 0 rgba(0,0,0,0.2);border:none;border-radius:12px 0 0 0;cursor:pointer}body:not(.i-amphtml-subs-grant-yes) .i-amphtml-subs-dialog-close-button{display:none}.i-amphtml-subs-progress{height:2px;background-color:#ccc;position:relative;margin:8px;overflow:hidden}.i-amphtml-subs-progress:after{content:"";background-color:#2196f3;height:2px;position:absolute;left:0;top:0;width:20%;animation:i-amphtml-subs-loading-progress 1500ms ease-in-out infinite}@keyframes i-amphtml-subs-loading-progress{0%{transform:translateX(-100%)}to{transform:translateX(500%)}}@media (min-width:480px){amp-subscriptions-dialog{width:480px!important;left:-240px!important;margin-left:50vw!important}}\n/*# sourceURL=/extensions/amp-subscriptions/0.1/amp-subscriptions.css*/'),0,"amp-subscriptions");if(i){const s=t.getRootNode();if(Zt(s,h))return h;const i=setInterval((()=>{Zt(s,h)&&clearInterval(i)}),4)}}(t,0,(()=>{})),this.Nl=null,this.fg=new class{constructor(t){this.Ni=t,this.oc=R(t,"mutator"),this.setGrantState(null),this.Tbt().classList.add(`${Jt}-ready`),this.addLoadingBar()}Tbt(){return this.Ni.getBody()}RF(t,s){this.oc.mutateElement(this.Ni.getBody(),(()=>{this.Tbt().classList.toggle(`${Jt}-${t}-unk`,null===s),this.Tbt().classList.toggle(`${Jt}-${t}-yes`,!0===s),this.Tbt().classList.toggle(`${Jt}-${t}-no`,!1===s)}))}addLoadingBar(){return this.Ni.whenReady().then((()=>{const t=this.Ni.getBody();if(!t.querySelector("[subscriptions-section=loading]")){const i=p(this.Ni.win.document,"div",{"class":"i-amphtml-subs-progress","subscriptions-section":"loading"});t.insertBefore(i,(s=t,f(/^[\w-]+$/.test("footer")),"> footer",s.querySelector(function(t,s){return t.replace(/^|,/g,"$&:scope ")}("> footer"))))}var s}))}Sbt(t,s){this.oc.mutateElement(this.Ni.getBody(),(()=>{this.Tbt().classList.toggle(`${Jt}-${t}`,s)}))}setGrantState(t){this.RF("grant",t)}toggleLoading(t){this.Sbt("loading",t)}}(t),this.kbt=null,this.Mbt=null,this.Vbt=null,this.xbt=P().assertElement(s),this.e9=new class{constructor(t){this._f=t,this.Wf=[]}registerEventListener(t){this.Wf.push(t)}serviceEvent(t,s,i,e){this.event(t,X({"serviceId":s},i),e)}event(t,s,i){i=i||{};const e=t!==q?t:t+`-${i.action}-${i.status}`;s=s||{},function(t,s,i={},e=!0){var n;(n=t,function(t,s,i,e){const n=T(t,s);if(n)return n;const r=S(t);return r.whenExtensionsKnown().then((()=>{const t=r.getExtensionVersion(i);return t?w(r.win,"extensions").waitForExtension(i,t):null})).then((i=>i?I(t,s):null))}(n,"amp-analytics-instrumentation","amp-analytics")).then((n=>{n&&n.triggerEventForTarget(t,s,i,e)}))}(this._f,e,s,!1);for(let e=0;e<this.Wf.length;e++)this.Wf[e](t,s,i)}actionEvent(t,s,i,e){this.serviceEvent(q,t,e,{"action":s,"status":i})}}(this.xbt),this.Y8=new class{constructor(t){this.S0=t}getAnalytics(){return this.S0.getAnalytics()}getDialog(){return this.S0.getDialog()}getEncryptedDocumentKey(t){return this.S0.getEncryptedDocumentKey(t)}getPageConfig(){return this.S0.getPageConfig()}getReaderId(t){return this.S0.getReaderId(t)}getScoreFactorStates(){return this.S0.getScoreFactorStates()}delegateActionToLocal(t,s){return this.delegateActionToService(t,"local",s)}delegateActionToService(t,s,i){return this.S0.delegateActionToService(t,s,i)}decorateServiceAction(t,s,i,e){this.S0.decorateServiceAction(t,s,i,e)}resetPlatforms(){this.S0.resetPlatforms()}selectPlatformForLogin(){return this.S0.selectPlatformForLogin()}loadMeteringState(){return this.S0.Obt?this.S0.Obt.loadMeteringState():Promise.resolve(null)}saveMeteringState(t){return this.S0.Obt?this.S0.Obt.saveMeteringState(t):i()}rememberMeteringEntitlementsWereFetched(){this.S0.Obt&&(this.S0.Obt.entitlementsWereFetchedWithCurrentMeteringState=!0)}}(this),this.dAt=new class{constructor(t){this.Ni=t,this.ar=w(t.win,"vsync"),this.Ie=C(t.win),this.Uu=U(t),this.Zr=!1,this.nN=null,this.Cbt=i();const s=this.Ni.win.document;this.Tr=p(s,"amp-subscriptions-dialog",{"role":"dialog"}),ft(this.Tr,!1),this.yC=p(s,"button",{"class":"i-amphtml-subs-dialog-close-button"}),this.showCloseAction(!1),this.Tr.appendChild(this.yC),this.yC.addEventListener("click",(()=>{this.close()})),this.Ni.getBody().appendChild(this.Tr),at(this.Tr,{transform:"translateY(100%)"})}getRoot(){return this.Tr}isVisible(){return this.Zr}open(t,s=!0){return this.tc((()=>this.HT(t,s)))}close(){return this.tc((()=>this.UT()))}tc(t){return this.Cbt=this.Cbt.then(t)}HT(t,s=!0){return this.nN?this.Tr.replaceChild(t,this.nN):this.Tr.appendChild(t),this.nN=t,this.Zr?i():(this.Zr=!0,this.ar.mutatePromise((()=>{ft(this.Tr,!0),this.showCloseAction(s)})).then((()=>this.ar.mutatePromise((()=>{at(this.Tr,{transform:"translateY(0)"})})).then((()=>this.Ie.promise(300))))).then((()=>{let t;return this.ar.runPromise({measure:()=>{t=this.Tr.offsetHeight},mutate:()=>{this.Uu.updatePaddingBottom(t),this.Uu.addToFixedLayer(this.Tr,!0)}})})))}UT(){return this.Zr?this.ar.mutatePromise((()=>{at(this.Tr,{transform:"translateY(100%)"})})).then((()=>this.Ie.promise(300))).then((()=>this.ar.mutatePromise((()=>{ft(this.Tr,!1),this.Uu.updatePaddingBottom(0),this.Zr=!1})))):i()}showCloseAction(t){ft(this.yC,t)}}(t),this.Lbt=new class{constructor(t){this.Ni=t,this.SAt=null,this.Ie=C(t.win),this.Uu=U(t)}scheduleView(t){return this.SAt=null,this.Ni.whenReady().then((()=>new Promise((t=>{this.Ni.isVisible()&&t(),this.Ni.onVisibilityChanged((()=>{this.Ni.isVisible()&&t()}))})).then((()=>this.UPt(t)))))}UPt(t){return this.SAt||(this.SAt=this.CPt(t).catch((t=>{throw this.SAt=null,t}))),this.SAt}CPt(t){if(0==t)return i();const s=[];return new Promise(((i,e)=>{s.push(this.Ni.onVisibilityChanged((()=>{this.Ni.isVisible()||e(new Error("CANCELLED"))})));const n=this.Ie.delay(i,t);s.push((()=>this.Ie.cancel(n))),s.push(this.Uu.onScroll(i)),s.push(function(t,s,i,e){let n=i;const r=It(t,"click",(t=>{try{n(t)}finally{n=null,r()}}),void 0);return r}(this.Ni.getRootNode(),0,i))})).then((()=>{s.forEach((t=>t()))}),(t=>{throw s.forEach((t=>t())),t}))}}(t),this.Fe=L(t),this.Ubt=null,this.Ie=C(t.win),this.Dbt=this.Fe.hasCapability("auth"),this.Nbt=this.Dbt&&this.Fe.hasCapability("paywall"),this.TAt=I(t,"cid"),this.jbt={},this.Fbt=new class{constructor(t){this.Ni=t,this.$bt=null;const s=this.Ni.getRootNode().querySelector("script[cryptokeys]");this.zbt=null,s&&s.hasAttribute("sha-256-hash")&&(this.zbt=s.getAttribute("sha-256-hash")),this.Kbt=s&&a(s.textContent)||null}isDocumentEncrypted(){return!!this.Kbt&&Object.keys(this.Kbt).length>0}getEncryptedKeys(){return this.Kbt}getEncryptedDocumentKey(t){const s=this.getEncryptedKeys();return s&&s[t]||null}tryToDecryptDocument(t){if(!this.zbt)return this.Gbt(t);const s=(i=t,"undefined"!=typeof TextEncoder?(new TextEncoder).encode(i):nt(unescape(encodeURIComponent(i))));var i;return crypto.subtle.digest("SHA-256",s).then((s=>{var i;return((i=new Uint8Array(s))?Array.prototype.slice.call(i):[]).map((t=>function(t,s,i){if(t.length>=s)return t;s-=t.length;let e="0";for(;s>e.length;)e+="0";return e.slice(0,s)+t}(t.toString(16),2))).join("")!=this.zbt?Promise.reject(new Error("Invalid Document Key")):this.Gbt(t)}))}Gbt(t){return this.$bt||(this.$bt=this.Ni.whenReady().then((()=>{return(s=ot(t).buffer,rt((self.msCrypto?self.msCrypto.subtle:self.crypto.subtle).importKey("raw",s,"AES-GCM",!0,["decrypt"]))).then((t=>{const s=this.Ni.getRootNode().querySelectorAll("script[ciphertext]"),i=[];return s.forEach((s=>{const e=ot(s.textContent.replace(/\s+/g,"")).buffer,n=e.slice(0,12),r=e.slice(12);i.push(function(t,s,i){const e=!!self.msCrypto;return rt((e?self.msCrypto.subtle:self.crypto.subtle).decrypt({name:"AES-GCM",iv:s,tag:e?i.slice(i.byteLength-16):void 0,tagLength:128},t,e?i.slice(0,i.byteLength-16):i)).then((t=>function(t){if("undefined"!=typeof TextDecoder)return new TextDecoder("utf-8").decode(t);const s=new Uint8Array(t.buffer||t),i=new Array(s.length);for(let t=0;t<s.length;t++)i[t]=String.fromCharCode(s[t]);const e=i.join("");return decodeURIComponent(escape(e))}(new Uint8Array(t))))}(t,n,r).then((t=>{s.outerHTML=t})))})),Promise.all(i)}));var s}))),this.$bt}}(t),this.Obt=null}start(){return this.pe().then((()=>{if(this.e9.event("subscriptions-started"),this.fg.toggleLoading(!0),E(this.kbt,"Page config is null"),this.Dbt)return this.Bbt(),void this.Wbt(!1);E(this.Mbt.services,"Services not configured in service config");const t=this.Mbt.services.map((t=>t.serviceId||"local"));this.Jbt(t),this.Mbt.services.forEach((t=>{this.Ybt(t)})),this.Vbt.getAvailablePlatforms().forEach((t=>{this.Hbt(t)})),function(t){return t.waitForBodyOpen().then((()=>{const s=t.getBody(),i=(e=s,n=()=>!!s.firstElementChild,new Promise((t=>{!function(t,s,i){if(s(t))i();else{const e=new(d(t).MutationObserver)((()=>{s(t)&&(e.disconnect(),i())}));e.observe(t,{childList:!0})}}(e,n,t)})));var e,n;return C(t.win).timeoutPromise(2e3,i).then((()=>"AMP-STORY"===s.firstElementChild.tagName),(()=>!1))}))}(this.Ni).then((t=>{t&&this.dAt.getRoot().classList.add("i-amphtml-story-subscriptions-dialog-wrapper"),this.Wbt(!t)}))})),this}getAccessReaderId(){return this.pe().then((()=>this.getReaderId("local")))}getAnalytics(){return this.e9}getAuthdataField(t){return this.pe().then((()=>this.Vbt.getEntitlementPromiseFor("local"))).then((s=>c(s.json(),t)))}getDialog(){return this.dAt}maybeRenderDialogForSelectedPlatform(){return this.pe().then((()=>{if(!this.Dbt&&!this.Mbt.alwaysGrant)return this.Qbt()}))}getGrantStatus(){return this.Vbt.getGrantStatus()}addOnEntitlementResolvedCallback(t){this.Vbt.addOnEntitlementResolvedCallback(t)}getEncryptedDocumentKey(t){return this.Fbt.getEncryptedDocumentKey(t)}getPageConfig(){return v(this.kbt)}getReaderId(t){let s=this.jbt[t];if(!s){const e=i(),n="amp-access"+("local"==t?"":"-"+t);s=this.TAt.then((t=>t.get({scope:n,createCookieIfNotPresent:!0},e))),this.jbt[t]=s}return s}getScoreFactorStates(){return this.Vbt.getScoreFactorStates()}registerPlatform(t,s){return this.pe().then((()=>{if(this.Dbt)return;const i=E(this.Mbt.services.filter((s=>(s.serviceId||"local")===t))[0],"No matching services for the ID found"),e=s(i,this.Y8);this.Vbt.resolvePlatform(e.getPlatformKey(),e),this.e9.serviceEvent("subscriptions-service-registered",e.getPlatformKey()),this.e9.serviceEvent("subscriptions-platform-registered",e.getPlatformKey()),this.Hbt(e)}))}selectPlatformForLogin(){return this.Vbt.selectPlatformForLogin()}pe(){if(!this.Nl){const t=new class{constructor(t){this.Ni=t,this.Uu=U(this.Ni)}getWin(){return this.Ni.win}getRootNode(){return this.Ni.getRootNode()}getRootElement(){const t=this.Ni.getRootNode();return t.documentElement||t.body||t}getHead(){return this.Ni.getHeadNode()}getBody(){return this.Ni.isBodyAvailable()?this.Ni.getBody():null}isReady(){return this.Ni.isReady()}whenReady(){return this.Ni.whenReady()}addToFixedLayer(t){return this.Uu.addToFixedLayer(t,!0)}}(this.Ni),s=new class{constructor(t){var s;this.doc_=9===(s=t).nodeType||s.document?new class{constructor(t){const s=!!t.document;this.win_=s?t:t.defaultView,this.doc_=s?t.document:t}getWin(){return this.win_}getRootNode(){return this.doc_}getRootElement(){return this.doc_.documentElement}getHead(){return this.doc_.head}getBody(){return this.doc_.body}isReady(){return D(this.doc_)}whenReady(){return t=this.doc_,new Promise((s=>{!function(t,s){!function(t,s,i){if(s(t))return void i(t);let e=!1;const n=()=>{s(t)&&!e&&(i(t),e=!0,t.removeEventListener("readystatechange",n))};t.addEventListener("readystatechange",n)}(t,D,s)}(t,s)}));var t}addToFixedLayer(t){return i()}}(s):s,this.configResolver_=null,this.configPromise_=new Promise((t=>{this.configResolver_=t})),this.metaParser_=new class{constructor(t){this.doc_=t}check(){if(!this.doc_.getBody())return null;const t=H(this.doc_.getRootNode(),"subscriptions-product-id");if(!t)return null;const s=H(this.doc_.getRootNode(),"subscriptions-accessible-for-free"),i=!(!s||"false"!==s.toLowerCase());return new N(t,i)}}(this.doc_),this.ldParser_=new class{constructor(t){this.doc_=t,this.checkType_=new Y}check(){if(!this.doc_.getBody())return null;const t=this.doc_.isReady(),s=this.doc_.getRootNode().querySelectorAll('script[type="application/ld+json"]');for(let i=0;i<s.length;i++){const e=s[i];if(e[B]||!e.textContent||!t&&!F(e))continue;if(e[B]=!0,!J.test(e.textContent))continue;const n=this.tryExtractConfig_(e);if(n)return n}return null}tryExtractConfig_(t){let s=function(t,s){try{return function(t){return JSON.parse(t)}(t)}catch(t){return}}(t.textContent);if(!s)return null;Array.isArray(s)||(s=[s]);let i=s;for(let t=0;t<i.length;t++){const s=i[t];if(s["@graph"]&&Array.isArray(s["@graph"])&&(i=i.concat(s["@graph"])),!this.checkType_.checkValue(s["@type"],W))continue;let e=null;const n=this.valueArray_(s,"isPartOf");if(n)for(let t=0;t<n.length&&(e=this.discoverProductId_(n[t]),!e);t++);if(!e)continue;const r=this.bool_(this.singleValue_(s,"isAccessibleForFree"),!0);return new N(e,!r)}return null}bool_(t,s){if(null==t||""===t)return s;if("boolean"==typeof t)return t;if("string"==typeof t){const s=t.toLowerCase();if("false"==s)return!1;if("true"==s)return!0}return s}discoverProductId_(t){return this.checkType_.checkValue(t["@type"],["Product"])?this.singleValue_(t,"productID"):null}valueArray_(t,s){const i=t[s];return null==i||""===i?null:Array.isArray(i)?i:[i]}singleValue_(t,s){const i=this.valueArray_(t,s),e=i&&i[0];return null==e||""===e?null:e}}(this.doc_),this.microdataParser_=new class{constructor(t){this.doc_=t,this.access_=null,this.productId_=null,this.checkType_=new Y}discoverAccess_(t){const s=t.querySelectorAll("[itemprop='isAccessibleForFree']");for(let i=0;s[i];i++){const e=s[i],n=e.getAttribute("content")||e.textContent;if(n&&this.isValidElement_(e,t,"alreadySeenForAccessInfo")){let t=null;return"true"==n.toLowerCase()?t=!0:"false"==n.toLowerCase()&&(t=!1),t}}return null}isValidElement_(t,s,i){for(let s=t;s&&!s[i];s=s.parentNode)if(s[i]=!0,s.hasAttribute&&s.hasAttribute("itemscope")){const t=s.getAttribute("itemtype");return this.checkType_.checkString(t,W)}return!1}discoverProductId_(t){const s=t.querySelectorAll('[itemprop="productID"]');for(let i=0;s[i];i++){const e=s[i],n=e.getAttribute("content")||e.textContent,r=e.closest("[itemtype][itemscope]");if(!(r.getAttribute("itemtype").indexOf("http://schema.org/Product")<=-1)&&this.isValidElement_(r.parentElement,t,"alreadySeenForProductInfo"))return n}return null}getPageConfig_(){let t=null;return null!=this.access_?t=!this.access_:this.doc_.isReady()&&(t=!1),null!=this.productId_&&null!=t?new N(this.productId_,t):null}tryExtractConfig_(){let t=this.getPageConfig_();if(t)return t;const s=Array.prototype.slice.call(this.doc_.getRootNode().querySelectorAll("[itemscope][itemtype]")).filter((t=>this.checkType_.checkString(t.getAttribute("itemtype"),W)));for(let i=0;s[i]&&null==t;i++){const e=s[i];null==this.access_&&(this.access_=this.discoverAccess_(e)),this.productId_||(this.productId_=this.discoverProductId_(e)),t=this.getPageConfig_()}return t}check(){return this.doc_.getBody()?this.tryExtractConfig_():null}}(this.doc_)}resolveConfig(){return i().then(this.check.bind(this)),this.doc_.whenReady().then(this.check.bind(this)),this.configPromise_}check(){if(!this.configResolver_)return null;let t=this.metaParser_.check();return t||(t=this.ldParser_.check()),t||(t=this.microdataParser_.check()),t?(this.configResolver_(t),this.configResolver_=null):this.doc_.isReady()&&(this.configResolver_(Promise.reject(G.createError("No config could be discovered in the page"))),this.configResolver_=null),function(t){if(/swg.debug=1/.test(self.location.hash)){const t=Array.prototype.slice.call(arguments,0);t.unshift("[Subscriptions]"),j.apply(j,t)}}(t),t}}(t);this.Nl=Promise.all([this.Zbt(),s.resolveConfig()]).then((t=>{this.Mbt=t[0],this.kbt=t[1]})).then((()=>{this.Xbt()}))}return this.Nl}Ybt(t){"local"==(t.serviceId||"local")&&this.Vbt.resolvePlatform("local",Gt(this.Ni,t,this.Y8))}Zbt(){return new Promise((t=>{t(a(this.xbt.textContent,(t=>{throw P().createError('Failed to parse "amp-subscriptions" JSON: ',t)})))}))}qbt(t){this.fg.toggleLoading(!1),this.Ubt=this.Lbt.scheduleView(2e3),this.Nbt&&!t||this.fg.setGrantState(t)}LPt(t,s){this.Vbt.resolveEntitlement(t,s),s.decryptedDocumentKey&&this.Fbt.tryToDecryptDocument(s.decryptedDocumentKey),this.e9.serviceEvent("subscriptions-entitlement-resolved",t)}DPt(t){return t.getEntitlements().then((s=>s&&s.granted&&this.Fbt.isDocumentEncrypted()&&!s.decryptedDocumentKey?(("local"==t.getPlatformKey()?P():y()).error(qt,`${t.getPlatformKey()}: Subscription granted and encryption enabled, but no decrypted document key returned.`),null):s))}Hbt(t){return this.NPt()?i():(t.isPrerenderSafe()?i():this.Ni.whenFirstVisible()).then((()=>this.Ie.timeoutPromise(3e3,this.DPt(t)).then((s=>(s=s||_t.empty(t.getPlatformKey()),this.LPt(t.getPlatformKey(),s),s))).catch((s=>{const i=t.getPlatformKey();throw this.Vbt.reportPlatformFailureAndFallback(i),P().createError(`fetch entitlements failed for ${i}`,s)}))))}Jbt(t){const s=this.Mbt.fallbackEntitlement?_t.parseFromJson(this.Mbt.fallbackEntitlement):_t.empty("local");this.Vbt=new Wt(t,this.Mbt.score,s),this.jPt(this.Vbt)}Bbt(){const t=vt(this.Ni.win);this.Jbt(["local"]),this.Mbt.services.forEach((s=>{if("local"==(s.serviceId||"local")){const i=new class{constructor(t,s,i,e){this.Ni=t,this.Y8=i,this.kbt=i.getPageConfig(),this.Or=Gt(t,s,i),this.Fe=L(this.Ni),this.Fe.onMessage("subscriptionchange",this.FPt.bind(this)),this.G_t=new class{constructor(t){this.win=t,this.J_t=t.crypto&&(t.crypto.subtle||t.crypto.webkitSubtle)||null}decode(t){return this.K_t(t).payload}isVerificationSupported(){return!!this.J_t}decodeAndVerify(t,s){if(!this.J_t)throw new Error("Crypto is not supported on this platform");return new Promise((s=>s(this.K_t(t)))).then((t=>{const i=t.header.alg;if(!i||"RS256"!=i)throw new Error("Only alg=RS256 is supported");return this.H_t(s).then((s=>{const i=Ht(t.sig);return this.J_t.verify({name:"RSASSA-PKCS1-v1_5"},s,i,nt(t.verifiable))})).then((s=>{if(s)return t.payload;throw new Error("Signature verification failed")}))}))}K_t(t){function s(){throw new Error(`Invalid token: "${t}"`)}const i=t.split(".");3!=i.length&&s();const e=Ht(i[0]),n=Ht(i[1]);return{header:a(et(e),s),payload:a(et(n),s),verifiable:`${i[0]}.${i[1]}`,sig:i[2]}}H_t(t){return t.then((t=>this.J_t.importKey("spki",function(t){const s=t.trim().replace(/^-+BEGIN[^-]*-+/,"").replace(/-+END[^-]*-+$/,"").replace(/[\r\n]/g,"").trim();return nt(atob(s))}(t),{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"])))}}(t.win),this.$Pt=this.kbt.getPublicationId(),this.KPt=this.kbt.getProductId(),this.h=e,this.Ie=C(t.win)}isPrerenderSafe(){return!0}getEntitlements(){v(this.KPt);const t={"publicationId":this.$Pt,"productId":this.KPt,"origin":this.h};let s;const i=this.Fe.getParam("cryptokeys")||"google.com";if(i){const t=i.split(",");for(let i=0;i!=t.length&&(s=this.Y8.getEncryptedDocumentKey(t[i]),!s);i++);}return s&&(t.encryptedDocumentKey=s),this.Ie.timeoutPromise(3e3,this.Fe.sendMessageAwaitResponse("auth",t)).then((t=>{const s=(t=t||{}).error,i=t.authorization,e=t.decryptedDocumentKey;if(s)throw new Error(s.message);return i?this.GPt(i,e).catch((t=>{throw this.BPt(t.message),t})):_t.empty("local")}))}GPt(t,s){return new Promise((i=>{const e=vt(this.Ni.win),n=Et(function(t){if(!function(t){return Pt.cdnProxyRegex.test(yt(t).origin)}(t=yt(t)))return t.href;const s=t.pathname.split("/"),i=s[1];E(At.has(i),"Unknown path prefix in url %s",t.href);const e=s[2],n="s"==e?"https://"+decodeURIComponent(s[3]):"http://"+decodeURIComponent(e);return E(n.indexOf(".")>0,"Expected a . in origin %s",n),s.splice(1,"s"==e?3:2),n+s.join("/")+function(t,s){if(!t||"?"==t)return"";const i=new RegExp("[?&](amp_(js[^&=]*|gsa|r|kit)|usqp)\\b[^&]*","g"),e=t.replace(i,"").replace(/^[?&]/,"");return e?"?"+e:""}(t.search)+(t.hash||"")}(this.Ni.win.location)).origin,r=this.G_t.decode(t),o=E(this.kbt.getProductId(),"Product id is null");if(r.aud!=e&&r.aud!=n)throw P().createError(`The mismatching "aud" field: ${r.aud}`);if(r.exp<Math.floor(Date.now()/1e3))throw P().createError("Payload is expired");const h=r.entitlements;let c,u=_t.empty("local");if(h){if(Array.isArray(h)){for(let t=0;t<h.length;t++)if(-1!==h[t].products.indexOf(o)){c=h[t];break}}else-1!==h.products.indexOf(o)&&(c=h);c&&(u=new _t({source:"viewer",raw:t,granted:!0,grantReason:c.subscriptionToken?mt:"",dataObject:c,decryptedDocumentKey:s}))}r.metering&&!u.granted&&(u=new _t({source:r.iss||"",raw:t,granted:!0,grantReason:gt,dataObject:r.metering,decryptedDocumentKey:s})),u.service="local",i(u)}))}BPt(t){this.Fe.sendMessage("auth-rejected",{"reason":t})}getPlatformKey(){return this.Or.getPlatformKey()}activate(){}reset(){}isPingbackEnabled(){return this.Or.isPingbackEnabled()}pingbackReturnsAllEntitlements(){return this.Or.pingbackReturnsAllEntitlements()}pingback(t){this.Or.pingback(t)}getSupportedScoreFactor(t){return this.Or.getSupportedScoreFactor(t)}getBaseScore(){return 0}executeAction(t,s){return this.Or.executeAction(t,s)}decorateUI(t,s,i){return this.Or.decorateUI(t,s,i)}FPt(){this.Y8.resetPlatforms()}}(this.Ni,s,this.Y8,t);this.Vbt.resolvePlatform("local",i),this.DPt(i).then((t=>{v(t),this.LPt("local",t)})).catch((t=>{this.Vbt.reportPlatformFailureAndFallback("local"),y().error(qt,"Viewer auth failed:",t)}))}}))}Wbt(t=!0){const s=this.Vbt.getGrantStatus(),i=this.Vbt.getGrantEntitlement();return Promise.all([s,i]).then((s=>{const i=s[0],e=s[1],n=()=>this.WPt({granted:i,shouldActivatePlatform:t});if(!this.Obt)return void n();const r=this.Vbt.getPlatform(this.Obt.platformKey);if(i){if(!e||e.grantReason!==gt||e.service!==this.Obt.platformKey)return void n();const t=()=>{this.WPt({granted:!0,shouldActivatePlatform:!1})};r.activate(e,e,t)}else this.Obt.entitlementsWereFetchedWithCurrentMeteringState?n():this.Obt.loadMeteringState().then((t=>{if(t)this.resetPlatform(this.Obt.platformKey);else{const t=_t.empty("local"),s=()=>this.Wbt();r.activate(t,t,s)}}))}))}WPt({granted:t,shouldActivatePlatform:s}){this.qbt(t),this.JPt(),s&&this.Qbt()}Qbt(){return Promise.all([this.Vbt.getGrantStatus(),this.Vbt.selectPlatform(),this.Vbt.getGrantEntitlement()]).then((t=>{const s=t[1],i=t[2],e=this.Vbt.getResolvedEntitlementFor(s.getPlatformKey()),n=i||e;s.activate(e,i),this.e9.serviceEvent("subscriptions-service-activated",s.getPlatformKey()),this.e9.serviceEvent("subscriptions-platform-activated",s.getPlatformKey()),n.granted?this.e9.serviceEvent("subscriptions-access-granted",n.service):(this.e9.serviceEvent("subscriptions-paywall-activated",s.getPlatformKey()),this.e9.serviceEvent("subscriptions-access-denied",s.getPlatformKey()))}))}JPt(){return this.Ubt?this.Ubt.then((()=>{this.Vbt.getAvailablePlatforms().forEach((t=>{t.isPingbackEnabled()&&(t.pingbackReturnsAllEntitlements()?this.Vbt.getAllPlatformsEntitlements().then((s=>t.pingback(s))):this.Vbt.getGrantEntitlement().then((s=>t.pingback(s||_t.empty("local")))))}))})):null}resetPlatforms(){this.Vbt=this.Vbt.resetPlatformStore(),this.fg.toggleLoading(!0),this.Obt&&(this.Obt.entitlementsWereFetchedWithCurrentMeteringState=!1),this.Vbt.getAvailablePlatforms().forEach((t=>{this.Hbt(t)})),this.e9.serviceEvent("subscriptions-service-re-authorized",""),this.e9.serviceEvent("subscriptions-platform-re-authorized",""),this.Wbt()}resetPlatform(t){this.fg.toggleLoading(!0),this.Vbt.resetPlatform(t);const s=this.Vbt.getPlatform(t);this.Hbt(s),this.Wbt()}delegateActionToLocal(t,s){return this.delegateActionToService(t,"local",s)}delegateActionToService(t,s,i=null){return new Promise((e=>{this.Vbt.onPlatformResolves(s,(n=>{v(n),this.e9.event("subscriptions-action-delegated",{"action":t,"serviceId":s},{"action":t,"status":tt}),e(n.executeAction(t,i))}))}))}decorateServiceAction(t,s,i,e){this.Vbt.onPlatformResolves(s,(s=>{v(s),s.decorateUI(t,i,e)}))}jPt(t){this.NPt()&&t.resolveEntitlement("local",new _t({source:"",raw:"",granted:!0,grantReason:bt,dataObject:{}}))}NPt(){return!this.kbt.isLocked()||this.Mbt.alwaysGrant}Xbt(){const{services:t}=this.Mbt,s=t.find((t=>t.enableMetering));s&&(this.Obt=new class{constructor({platformKey:t}){this.entitlementsWereFetchedWithCurrentMeteringState=!1,this.platformKey=t,this.YPt=""}saveMeteringState(t){const s=JSON.stringify(t);return Promise.resolve(this.YPt).then((t=>s!==t)).then((t=>{t&&(this.YPt=s,this.entitlementsWereFetchedWithCurrentMeteringState=!1)}))}loadMeteringState(){return this.YPt?Promise.resolve(JSON.parse(this.YPt)):Promise.resolve(null)}}({platformKey:s.serviceId}))}}(t).start()}))})();
/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */}});
//# sourceMappingURL=amp-subscriptions-0.1.mjs.map